<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Instrumentos — Gestión</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tu estilo global (pixel + paleta). Asegúrate que existe en public/style.css -->
  <link rel="stylesheet" href="style.css">

  <!-- Pixel font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

  <!-- navbar dinámico (si lo tienes) -->
  <div id="navbar-placeholder"></div>

  <div class="container mt-4">
    <h1 class="section-title mb-3">Gestión de Instrumentos</h1>
    <p class="text-muted">Administra el catálogo de instrumentos.</p>

    <!-- Form Crear (se oculta si rol = AUDITOR) -->
    <div id="cardCrear" class="card p-4 shadow-sm mb-4">
      <h5 class="card-title mb-3">Agregar nuevo instrumento</h5>

      <form id="formCrearInstrumento" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Nombre</label>
          <input name="nombre" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Categoría</label>
          <input name="categoria" class="form-control" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Estado</label>
          <select name="estado" class="form-select">
            <option value="DISPONIBLE">DISPONIBLE</option>
            <option value="PRESTADO">PRESTADO</option>
            <option value="EN REPARACIÓN">EN REPARACIÓN</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Ubicación</label>
          <input name="ubicacion" class="form-control">
        </div>

        <div class="col-12">
          <button id="btnCrear" class="btn btn-primary">Agregar instrumento</button>
        </div>
      </form>
    </div>

    <!-- Lista de instrumentos -->
    <div class="card p-3 shadow-sm">
      <h5 class="card-title">Lista de instrumentos</h5>

      <div class="table-responsive">
        <table class="table table-striped mt-3">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Categoría</th>
              <th>Estado</th>
              <th>Ubicación</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaInstrumentos"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal editar -->
  <div class="modal fade" id="modalEditarInstrumento" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="formEditarInstrumento">
          <div class="modal-header">
            <h5 class="modal-title">Editar instrumento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editId">

            <div class="mb-2">
              <label class="form-label">Nombre</label>
              <input id="editNombre" class="form-control" required>
            </div>

            <div class="mb-2">
              <label class="form-label">Categoría</label>
              <input id="editCategoria" class="form-control" required>
            </div>

            <div class="mb-2">
              <label class="form-label">Estado</label>
              <select id="editEstado" class="form-select">
                <option value="DISPONIBLE">DISPONIBLE</option>
                <option value="PRESTADO">PRESTADO</option>
                <option value="EN REPARACIÓN">EN REPARACIÓN</option>
              </select>
            </div>

            <div class="mb-2">
              <label class="form-label">Ubicación</label>
              <input id="editUbicacion" class="form-control">
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" id="btnGuardarEdit" class="btn btn-success">Guardar cambios</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // Estado de la sesión / rol
  let ROLE = null;

  // Cargar navbar si existe (opcional). No usamos credentials aquí porque navbar.html es estático.
  fetch('navbar.html').then(r => r.ok ? r.text() : '').then(html => {
    if (html) document.getElementById('navbar-placeholder').innerHTML = html;
  }).catch(()=>{});

  // Obtener tipo de usuario (usa cookies de sesión)
  async function obtenerTipoUsuario() {
    try {
      const res = await fetch('/tipo-usuario', { credentials: 'include' });
      if (res.status === 401) {
        // no autenticado -> redirigir al login
        window.location.href = '/login';
        return;
      }
      const json = await res.json();
      ROLE = (json.tipo_usuario || json.rol || '').toUpperCase();
      aplicarPermisosUI();
      cargarInstrumentos(); // cargar después de saber rol
    } catch (err) {
      console.error('Error al obtener tipo-usuario', err);
      window.location.href = '/login';
    }
  }

  // Mostrar/ocultar controles según rol
  function aplicarPermisosUI() {
    // Si auditor, ocultar el card de creación y deshabilitar botones de acción
    if (ROLE === 'AUDITOR') {
      const card = document.getElementById('cardCrear');
      if (card) card.style.display = 'none';
    } else {
      const card = document.getElementById('cardCrear');
      if (card) card.style.display = '';
    }
  }

  // Cargar instrumentos
  async function cargarInstrumentos() {
    try {
      const res = await fetch('/api/instrumentos', { credentials: 'include' });
      if (!res.ok) {
        const j = await res.json().catch(()=>({error:'error'}));
        alert('Error al cargar instrumentos: ' + (j.error||res.status));
        return;
      }
      const data = await res.json();
      const tbody = document.getElementById('tablaInstrumentos');
      tbody.innerHTML = '';
      data.forEach(inst => {
        // Si role es AUDITOR, ocultamos botones; si ASISTENTE o ADMIN mostramos Edit; only ADMIN can delete (based on your backend) — here we'll show delete only to ADMIN
        const canEdit = (ROLE === 'ADMIN' || ROLE === 'ASISTENTE');
        const canDelete = (ROLE === 'ADMIN');

        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${escapeHtml(inst.id)}</td>
            <td>${escapeHtml(inst.nombre)}</td>
            <td>${escapeHtml(inst.categoria)}</td>
            <td>${escapeHtml(inst.estado)}</td>
            <td>${escapeHtml(inst.ubicacion||'')}</td>
            <td>
              ${canEdit ? `<button class="btn btn-warning btn-sm me-2" onclick="abrirEditar(${inst.id})">Editar</button>` : ''}
              ${canDelete ? `<button class="btn btn-danger btn-sm" onclick="eliminarInstrumento(${inst.id})">Eliminar</button>` : ''}
            </td>
          </tr>
        `);
      });
    } catch (err) {
      console.error(err);
      alert('Fallo al obtener instrumentos');
    }
  }

  // Crear instrumento
  document.getElementById('formCrearInstrumento').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (ROLE === 'AUDITOR') return alert('No tienes permiso');

    const form = e.target;
    const payload = {
      nombre: form.nombre.value.trim(),
      categoria: form.categoria.value.trim(),
      estado: form.estado.value,
      ubicacion: form.ubicacion.value.trim()
    };

    try {
      const res = await fetch('/api/instrumentos', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if (!res.ok) return alert(j.error || 'Error al crear');
      alert(j.mensaje || 'Instrumento creado');
      form.reset();
      cargarInstrumentos();
    } catch (err) {
      console.error(err);
      alert('Error al crear instrumento');
    }
  });

  // Abrir editar (llenar modal con datos desde server)
  async function abrirEditar(id) {
    try {
      // pedir al servidor el instrumento (puedes reutilizar GET list; aquí simple)
      const resAll = await fetch('/api/instrumentos', { credentials: 'include' });
      const all = await resAll.json();
      const inst = all.find(i => String(i.id) === String(id));
      if (!inst) return alert('Instrumento no encontrado');

      document.getElementById('editId').value = inst.id;
      document.getElementById('editNombre').value = inst.nombre;
      document.getElementById('editCategoria').value = inst.categoria;
      document.getElementById('editEstado').value = inst.estado;
      document.getElementById('editUbicacion').value = inst.ubicacion || '';

      // show modal
      const modal = new bootstrap.Modal(document.getElementById('modalEditarInstrumento'));
      modal.show();
    } catch (err) {
      console.error(err);
      alert('Error al preparar edición');
    }
  }

  // Guardar edición
  document.getElementById('formEditarInstrumento').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (ROLE === 'AUDITOR') return alert('No tienes permiso');

    const id = document.getElementById('editId').value;
    const payload = {
      nombre: document.getElementById('editNombre').value.trim(),
      categoria: document.getElementById('editCategoria').value.trim(),
      estado: document.getElementById('editEstado').value,
      ubicacion: document.getElementById('editUbicacion').value.trim()
    };

    try {
      const res = await fetch(`/api/instrumentos/${encodeURIComponent(id)}`, {
        method: 'PUT',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if (!res.ok) return alert(j.error || 'Error al actualizar');
      alert(j.mensaje || 'Actualizado');
      // cerrar modal
      bootstrap.Modal.getInstance(document.getElementById('modalEditarInstrumento')).hide();
      cargarInstrumentos();
    } catch (err) {
      console.error(err);
      alert('Error al actualizar instrumento');
    }
  });

  // Eliminar instrumento
  async function eliminarInstrumento(id) {
    if (ROLE !== 'ADMIN') return alert('No tienes permiso para eliminar');
    if (!confirm('¿Eliminar instrumento?')) return;

    try {
      const res = await fetch(`/api/instrumentos/${encodeURIComponent(id)}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      const j = await res.json();
      if (!res.ok) return alert(j.error || 'Error al eliminar');
      alert(j.mensaje || 'Eliminado');
      cargarInstrumentos();
    } catch (err) {
      console.error(err);
      alert('Error al eliminar instrumento');
    }
  }

  // escape simple para evitar XSS en inserciones
  function escapeHtml(s) {
    if (s === null || s === undefined) return '';
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  // Inicializar
  obtenerTipoUsuario();
  </script>
</body>
</html>
