<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Instrumentos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">
</head>
<body>

<!-- NAVBAR -->
<div id="navbar"></div>
<script>
    fetch("navbar.html")
        .then(r => r.text())
        .then(html => document.getElementById("navbar").innerHTML = html);
</script>

<div class="container mt-4">

    <h2 class="mb-3">Gestión de Instrumentos</h2>

    <!-- FORM CREAR -->
    <div class="card p-4 shadow-sm mb-4">
        <h5 class="mb-3">Agregar nuevo instrumento</h5>

        <form id="formCrearInstrumento">
            <div class="row g-3">

                <div class="col-md-3">
                    <label class="form-label">Nombre</label>
                    <input type="text" name="nombre" class="form-control" required>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Categoría</label>
                    <input type="text" name="categoria" class="form-control" required>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Estado</label>
                    <select name="estado" class="form-select">
                        <option value="DISPONIBLE">DISPONIBLE</option>
                        <option value="PRESTADO">PRESTADO</option>
                        <option value="EN REPARACIÓN">EN REPARACIÓN</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Ubicación</label>
                    <input type="text" name="ubicacion" class="form-control">
                </div>

            </div>

            <button class="btn btn-primary mt-3" type="submit">Agregar</button>
        </form>
    </div>

    <!-- LISTA -->
    <div class="card p-4 shadow-sm">
        <h5>Lista de instrumentos</h5>

        <table class="table table-striped mt-3">
            <thead class="table-primary">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Categoría</th>
                    <th>Estado</th>
                    <th>Ubicación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaInstrumentos"></tbody>
        </table>
    </div>
</div>

<!-- MODAL DE EDICIÓN -->
<div class="modal fade" id="modalEditar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <form id="formEditarInstrumento">
                <div class="modal-header">
                    <h5 class="modal-title">Editar instrumento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <input type="hidden" id="editId">

                    <label class="form-label">Nombre</label>
                    <input type="text" id="editNombre" class="form-control" required>

                    <label class="form-label mt-2">Categoría</label>
                    <input type="text" id="editCategoria" class="form-control" required>

                    <label class="form-label mt-2">Estado</label>
                    <select id="editEstado" class="form-select">
                        <option value="DISPONIBLE">DISPONIBLE</option>
                        <option value="PRESTADO">PRESTADO</option>
                        <option value="EN REPARACIÓN">EN REPARACIÓN</option>
                    </select>

                    <label class="form-label mt-2">Ubicación</label>
                    <input type="text" id="editUbicacion" class="form-control">

                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Guardar cambios</button>
                </div>
            </form>

        </div>
    </div>
</div>



<script>

// ========== VERIFICAR LOGIN ==========
fetch('/tipo-usuario')
    .then(res => {
        if (res.status === 401) location.href = "/login";
        return res.json();
    });


// ========== CARGAR LISTA ==========
async function cargarInstrumentos() {
    const res = await fetch('/api/instrumentos');
    const data = await res.json();

    const tabla = document.getElementById("tablaInstrumentos");
    tabla.innerHTML = "";

    data.forEach(inst => {
        tabla.innerHTML += `
            <tr>
                <td>${inst.id}</td>
                <td>${inst.nombre}</td>
                <td>${inst.categoria}</td>
                <td>${inst.estado}</td>
                <td>${inst.ubicacion}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="abrirEditar(${inst.id}, '${inst.nombre}', '${inst.categoria}', '${inst.estado}', '${inst.ubicacion}')">Editar</button>
                </td>
            </tr>
        `;
    });
}

cargarInstrumentos();


// ========== AGREGAR INSTRUMENTO ==========
document.getElementById("formCrearInstrumento").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = e.target;
    const data = {
        nombre: form.nombre.value,
        categoria: form.categoria.value,
        estado: form.estado.value,
        ubicacion: form.ubicacion.value
    };

    const res = await fetch("/api/instrumentos", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    });

    const result = await res.json();
    alert(result.mensaje || result.error);

    cargarInstrumentos();
    form.reset();
});


// ========== ABRIR MODAL ==========
function abrirEditar(id, nombre, categoria, estado, ubicacion) {
    document.getElementById("editId").value = id;
    document.getElementById("editNombre").value = nombre;
    document.getElementById("editCategoria").value = categoria;
    document.getElementById("editEstado").value = estado;
    document.getElementById("editUbicacion").value = ubicacion;

    new bootstrap.Modal(document.getElementById("modalEditar")).show();
}


// ========== GUARDAR EDICIÓN ==========
document.getElementById("formEditarInstrumento").addEventListener("submit", async (e) => {
    e.preventDefault();

    const id = document.getElementById("editId").value;

    const data = {
        nombre: document.getElementById("editNombre").value,
        categoria: document.getElementById("editCategoria").value,
        estado: document.getElementById("editEstado").value,
        ubicacion: document.getElementById("editUbicacion").value
    };

    const res = await fetch(`/api/instrumentos/${id}`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    });

    const result = await res.json();
    alert(result.mensaje || result.error);

    cargarInstrumentos();
});
</script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
