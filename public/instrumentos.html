<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Instrumentos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div id="navbar"></div>

<div class="container mt-4">
  <h2 class="text-primary fw-bold">Gestionar Instrumentos</h2>
  <p class="text-muted">Registrar, consultar, editar y eliminar instrumentos.</p>

  <!-- FORMULARIO AGREGAR INSTRUMENTO -->
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">Registrar Instrumento</div>
    <div class="card-body">
      <form id="formInstrumento">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" id="nombre" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Categoría</label>
            <input type="text" class="form-control" id="categoria" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Estado</label>
            <select class="form-select" id="estado">
              <option value="DISPONIBLE">DISPONIBLE</option>
              <option value="PRESTADO">PRESTADO</option>
              <option value="MANTENIMIENTO">MANTENIMIENTO</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Ubicación</label>
            <input type="text" class="form-control" id="ubicacion">
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100">Guardar Instrumento</button>
      </form>
    </div>
  </div>

  <!-- CARGA Y DESCARGA DE EXCEL -->
  <div class="card shadow-sm mt-4">
    <div class="card-header bg-primary text-white">Importar / Exportar Excel</div>
    <div class="card-body">
      <form id="excelForm" enctype="multipart/form-data">
        <input type="file" class="form-control mb-2" name="excelFile" required>
        <button class="btn btn-success w-100" type="submit">Subir Excel</button>
      </form>
      <button class="btn btn-outline-primary w-100 mt-3" id="btnDescargar">Descargar Excel</button>
    </div>
  </div>

  <!-- TABLA INSTRUMENTOS -->
  <h3 class="mt-4 text-primary">Lista de Instrumentos</h3>
  <table class="table table-striped table-bordered" id="tablaInstrumentos">
    <thead class="table-primary">
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Categoría</th>
        <th>Estado</th>
        <th>Ubicación</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<script>
// Cargar navbar
fetch('navbar.html')
  .then(r => r.text())
  .then(html => document.getElementById('navbar').innerHTML = html);

// Obtener token y rol
const rol = localStorage.getItem("rol");

// Cargar instrumentos
function cargarInstrumentos() {
  fetch('/api/instrumentos', { headers: { 'x-rol': rol } })
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#tablaInstrumentos tbody");
      tbody.innerHTML = "";
      data.forEach(ins => {
        tbody.innerHTML += `
          <tr>
            <td>${ins.id}</td>
            <td>${ins.nombre}</td>
            <td>${ins.categoria}</td>
            <td>${ins.estado}</td>
            <td>${ins.ubicacion}</td>
          </tr>`;
      });
    });
}

// Guardar instrumento
document.getElementById("formInstrumento").addEventListener("submit", e => {
  e.preventDefault();

  const datos = {
    nombre: nombre.value,
    categoria: categoria.value,
    estado: estado.value,
    ubicacion: ubicacion.value
  };

  fetch('/api/instrumentos', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-rol': rol },
    body: JSON.stringify(datos)
  })
    .then(r => r.json())
    .then(d => {
      alert(d.mensaje);
      cargarInstrumentos();
    });
});

// Subir Excel
document.getElementById("excelForm").addEventListener("submit", e => {
  e.preventDefault();
  const formData = new FormData(e.target);

  fetch('/api/instrumentos/upload', {
    method: 'POST',
    body: formData
  })
    .then(r => r.json())
    .then(d => {
      alert(d.mensaje);
      cargarInstrumentos();
    });
});

// Descargar Excel
document.getElementById("btnDescargar").addEventListener("click", () => {
  window.location.href = '/api/instrumentos/download';
});

cargarInstrumentos();
</script>

</body>
</html>
