<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administración de Usuarios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div id="navbar"></div>
<script>
  fetch("navbar.html")
    .then(r => r.text())
    .then(html => document.getElementById("navbar").innerHTML = html);
</script>

<div class="container mt-4">

  <h2 class="mb-3">Administración de Usuarios</h2>

  <!-- FORM CREAR -->
  <div class="card p-4 shadow-sm mb-4">
    <h5>Crear nuevo usuario</h5>

    <form id="formCrearUsuario">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Nombre</label>
          <input name="nombre" class="form-control" required>
        </div>

        <div class="col-md-3">
          <label class="form-label">Correo</label>
          <input type="email" name="correo" class="form-control" required>
        </div>

        <div class="col-md-3">
          <label class="form-label">Password</label>
          <input type="password" name="password" class="form-control" required>
        </div>

        <div class="col-md-3">
          <label class="form-label">Rol</label>
          <select name="rol" class="form-select">
            <option value="ADMIN">ADMIN</option>
            <option value="ASISTENTE">ASISTENTE</option>
            <option value="AUDITOR">AUDITOR</option>
          </select>
        </div>
      </div>

      <button class="btn btn-primary mt-3">Crear Usuario</button>
    </form>
  </div>

  <!-- TABLA -->
  <div class="card p-4 shadow-sm">
    <h5>Lista de usuarios</h5>

    <table class="table table-striped mt-3">
      <thead class="table-primary">
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Rol</th>
        <th>Acciones</th>
      </tr>
      </thead>
      <tbody id="tablaUsuarios"></tbody>
    </table>
  </div>

</div>

<!-- MODAL EDITAR -->
<div class="modal fade" id="modalEditar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <form id="formEditarUsuario">
        <div class="modal-header">
          <h5 class="modal-title">Editar Usuario</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <input type="hidden" id="editId">

          <label class="form-label">Nombre</label>
          <input id="editNombre" class="form-control" required>

          <label class="form-label mt-2">Correo</label>
          <input id="editCorreo" class="form-control" required>

          <label class="form-label mt-2">Password (opcional)</label>
          <input id="editPassword" type="password" class="form-control">

          <label class="form-label mt-2">Rol</label>
          <select id="editRol" class="form-select">
            <option value="ADMIN">ADMIN</option>
            <option value="ASISTENTE">ASISTENTE</option>
            <option value="AUDITOR">AUDITOR</option>
          </select>

        </div>

        <div class="modal-footer">
          <button class="btn btn-success" type="submit">Guardar</button>
        </div>

      </form>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

// VERIFICAR LOGIN
fetch('/tipo-usuario').then(r => {
  if (r.status === 401) location.href = "/login";
});

// CARGAR USUARIOS
async function cargarUsuarios() {
  const res = await fetch('/api/usuarios');
  const usuarios = await res.json();

  const tbody = document.getElementById("tablaUsuarios");
  tbody.innerHTML = "";

  usuarios.forEach(u => {
    tbody.innerHTML += `
      <tr>
        <td>${u.id}</td>
        <td>${u.nombre}</td>
        <td>${u.correo}</td>
        <td>${u.rol}</td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="abrirEditar(${u.id}, '${u.nombre}', '${u.correo}', '${u.rol}')">Editar</button>
          <button class="btn btn-danger btn-sm" onclick="borrarUsuario(${u.id})">Borrar</button>
        </td>
      </tr>
    `;
  });
}

cargarUsuarios();

// ABRIR MODAL EDITAR
function abrirEditar(id, nombre, correo, rol) {
  document.getElementById("editId").value = id;
  document.getElementById("editNombre").value = nombre;
  document.getElementById("editCorreo").value = correo;
  document.getElementById("editRol").value = rol;
  document.getElementById("editPassword").value = "";

  new bootstrap.Modal(document.getElementById("modalEditar")).show();
}

// GUARDAR EDICIÓN
document.getElementById("formEditarUsuario").addEventListener("submit", async e => {
  e.preventDefault();

  const id = document.getElementById("editId").value;
  const data = {
    nombre: document.getElementById("editNombre").value,
    correo: document.getElementById("editCorreo").value,
    password: document.getElementById("editPassword").value,
    rol: document.getElementById("editRol").value,
  };

  const res = await fetch(`/api/usuarios/${id}`, {
    method: "PUT",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(data)
  });

  const r = await res.json();
  alert(r.mensaje || r.error);

  cargarUsuarios();
});

// BORRAR USUARIO
async function borrarUsuario(id) {
  if (!confirm("¿Seguro que deseas borrar este usuario?")) return;

  const res = await fetch(`/api/usuarios/${id}`, {
    method: "DELETE"
  });

  const r = await res.json();
  alert(r.mensaje || r.error);

  cargarUsuarios();
}

</script>

</body>
</html>
