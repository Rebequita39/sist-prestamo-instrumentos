<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Usuarios — Gestión</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <!-- Pixel font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

  <div id="navbar"></div>
  <script>
fetch("navbar.html")
  .then(r => r.text())
  .then(html => {
    document.getElementById("navbar").innerHTML = html;
    inicializarNavbar(); // Ejecutar controles DESPUÉS de insertar el navbar
  });

function inicializarNavbar() {

  fetch('/tipo-usuario', { credentials: 'include' })
    .then(r => r.json())
    .then(data => {
      const rol = (data.tipo_usuario || data.rol || "").toUpperCase();

      if (rol === "ADMIN") {
        document.getElementById("navUsuarios")?.classList.remove("d-none");
      }

      if (rol === "ASISTENTE") {
        document.getElementById("navUsuarios")?.classList.add("d-none");
      }

      if (rol === "AUDITOR") {
        document.getElementById("navUsuarios")?.classList.add("d-none");
        document.getElementById("navPrestamos")?.classList.add("d-none");
      }
    });
}
</script>

  <div class="container mt-4">
    <h1 class="section-title mb-3">Administración de Usuarios</h1>
    <p class="text-muted">Solo ADMIN puede crear/editar/borrar usuarios.</p>

    <!-- Crear usuario (solo ADMIN) -->
    <div id="cardCrearUsuario" class="card p-4 mb-4 shadow-sm">
      <h5 class="card-title">Crear nuevo usuario</h5>

      <form id="formCrearUsuario" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Nombre</label>
          <input name="nombre" class="form-control" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">Correo</label>
          <input name="correo" type="email" class="form-control" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">Contraseña</label>
          <input name="password" type="password" class="form-control" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">Rol</label>
          <select name="rol" class="form-select" required>
            <option value="ADMIN">ADMIN</option>
            <option value="ASISTENTE">ASISTENTE</option>
            <option value="AUDITOR">AUDITOR</option>
          </select>
        </div>

        <div class="col-12">
          <button id="btnCrearUsuario" class="btn btn-primary">Crear usuario</button>
        </div>
      </form>
    </div>

    <!-- Tabla usuarios -->
    <div class="card p-3 shadow-sm">
      <h5 class="card-title">Usuarios registrados</h5>
      <div class="table-responsive">
        <table class="table table-striped mt-3">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Correo</th>
              <th>Rol</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaUsuarios"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal editar usuario -->
  <div class="modal fade" id="modalEditarUsuario" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="formEditarUsuario">
          <div class="modal-header">
            <h5 class="modal-title">Editar usuario</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="userEditId">

            <div class="mb-2">
              <label class="form-label">Nombre</label>
              <input id="userEditNombre" class="form-control" required>
            </div>

            <div class="mb-2">
              <label class="form-label">Correo</label>
              <input id="userEditCorreo" class="form-control" required>
            </div>

            <div class="mb-2">
              <label class="form-label">Rol</label>
              <select id="userEditRol" class="form-select">
                <option value="ADMIN">ADMIN</option>
                <option value="ASISTENTE">ASISTENTE</option>
                <option value="AUDITOR">AUDITOR</option>
              </select>
            </div>

            <div class="mb-2">
              <label class="form-label">Nueva contraseña (opcional)</label>
              <input id="userEditPassword" type="password" class="form-control">
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Guardar</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  let ROLE = null;

  // cargar navbar si existe
  fetch('navbar.html').then(r => r.ok ? r.text() : '').then(html => {
    if (html) document.getElementById('navbar-placeholder').innerHTML = html;
  }).catch(()=>{});

  async function obtenerTipoUsuario() {
    try {
      const res = await fetch('/tipo-usuario', { credentials: 'include' });
      if (res.status === 401) {
        window.location.href = '/login';
        return;
      }
      const json = await res.json();
      ROLE = (json.tipo_usuario || json.rol || '').toUpperCase();
      aplicarPermisosUI();
      cargarUsuarios();
    } catch (err) {
      console.error(err);
      window.location.href = '/login';
    }
  }

  function aplicarPermisosUI() {
    // Solo ADMIN puede ver el formulario de crear y las acciones
    if (ROLE !== 'ADMIN') {
      const card = document.getElementById('cardCrearUsuario');
      if (card) card.style.display = 'none';
    } else {
      const card = document.getElementById('cardCrearUsuario');
      if (card) card.style.display = '';
    }
  }

  // Cargar usuarios
  async function cargarUsuarios() {
    try {
      const res = await fetch('/api/usuarios', { credentials: 'include' });
      if (!res.ok) {
        const j = await res.json().catch(()=>({error:'error'}));
        alert('Error al cargar usuarios: ' + (j.error || res.status));
        return;
      }
      const users = await res.json();
      const tbody = document.getElementById('tablaUsuarios');
      tbody.innerHTML = '';
      users.forEach(u => {
        const canEdit = (ROLE === 'ADMIN');
        const canDelete = (ROLE === 'ADMIN');
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${escapeHtml(u.id)}</td>
            <td>${escapeHtml(u.nombre)}</td>
            <td>${escapeHtml(u.correo)}</td>
            <td>${escapeHtml(u.rol)}</td>
            <td>
              ${canEdit ? `<button class="btn btn-warning btn-sm me-2" onclick="abrirEditarUsuario(${u.id})">Editar</button>` : ''}
              ${canDelete ? `<button class="btn btn-danger btn-sm" onclick="eliminarUsuario(${u.id})">Eliminar</button>` : ''}
            </td>
          </tr>
        `);
      });
    } catch (err) {
      console.error(err);
      alert('Fallo al cargar usuarios');
    }
  }

  // Crear usuario (POST /api/usuarios) - solo ADMIN (backend también lo valida)
  document.getElementById('formCrearUsuario').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (ROLE !== 'ADMIN') return alert('No tienes permiso');

    const form = e.target;
    const payload = {
      nombre: form.nombre.value.trim(),
      correo: form.correo.value.trim(),
      password: form.password.value,
      rol: form.rol.value
    };

    try {
      const res = await fetch('/api/usuarios', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if (!res.ok) return alert(j.error || 'Error al crear usuario');
      alert(j.mensaje || 'Usuario creado');
      form.reset();
      cargarUsuarios();
    } catch (err) {
      console.error(err);
      alert('Error al crear usuario');
    }
  });

  // Abrir modal editar usuario
  async function abrirEditarUsuario(id) {
    try {
      // solicitar lista y buscar el usuario por id
      const res = await fetch('/api/usuarios', { credentials: 'include' });
      const users = await res.json();
      const u = users.find(x => String(x.id) === String(id));
      if (!u) return alert('Usuario no encontrado');

      document.getElementById('userEditId').value = u.id;
      document.getElementById('userEditNombre').value = u.nombre;
      document.getElementById('userEditCorreo').value = u.correo;
      document.getElementById('userEditRol').value = u.rol;
      document.getElementById('userEditPassword').value = '';

      new bootstrap.Modal(document.getElementById('modalEditarUsuario')).show();
    } catch (err) {
      console.error(err);
      alert('Error al preparar edición');
    }
  }

  // Guardar edición usuario (PUT /api/usuarios/:id)
  document.getElementById('formEditarUsuario').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (ROLE !== 'ADMIN') return alert('No tienes permiso');

    const id = document.getElementById('userEditId').value;
    const payload = {
      nombre: document.getElementById('userEditNombre').value.trim(),
      correo: document.getElementById('userEditCorreo').value.trim(),
      rol: document.getElementById('userEditRol').value,
      password: document.getElementById('userEditPassword').value
    };

    try {
      const res = await fetch(`/api/usuarios/${encodeURIComponent(id)}`, {
        method: 'PUT',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if (!res.ok) return alert(j.error || 'Error al actualizar usuario');
      alert(j.mensaje || 'Usuario actualizado');
      bootstrap.Modal.getInstance(document.getElementById('modalEditarUsuario')).hide();
      cargarUsuarios();
    } catch (err) {
      console.error(err);
      alert('Error al actualizar usuario');
    }
  });

  // Eliminar usuario (DELETE /api/usuarios/:id)
  async function eliminarUsuario(id) {
    if (ROLE !== 'ADMIN') return alert('No tienes permiso');
    if (!confirm('¿Eliminar usuario?')) return;
    try {
      const res = await fetch(`/api/usuarios/${encodeURIComponent(id)}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      const j = await res.json();
      if (!res.ok) return alert(j.error || 'Error al eliminar usuario');
      alert(j.mensaje || 'Usuario eliminado');
      cargarUsuarios();
    } catch (err) {
      console.error(err);
      alert('Error al eliminar usuario');
    }
  }

  // escape helper
  function escapeHtml(s) {
    if (s === null || s === undefined) return '';
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  // Inicializar
  obtenerTipoUsuario();
  </script>
</body>
</html>
