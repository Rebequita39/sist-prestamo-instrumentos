<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Préstamos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">
</head>

<body class="bg-light">

<div id="navbar"></div>
<script>
fetch("navbar.html")
  .then(r => r.text())
  .then(html => {
    document.getElementById("navbar").innerHTML = html;
    inicializarNavbar(); // Ejecutar controles DESPUÉS de insertar el navbar
  });

function inicializarNavbar() {

  fetch('/tipo-usuario', { credentials: 'include' })
    .then(r => r.json())
    .then(data => {
      const rol = (data.tipo_usuario || data.rol || "").toUpperCase();

      if (rol === "ADMIN") {
        document.getElementById("navUsuarios")?.classList.remove("d-none");
      }

      if (rol === "ASISTENTE") {
        document.getElementById("navUsuarios")?.classList.add("d-none");
      }

      if (rol === "AUDITOR") {
        document.getElementById("navUsuarios")?.classList.add("d-none");
        document.getElementById("navPrestamos")?.classList.add("d-none");
      }
    });
}
</script>

<div class="container mt-4">
  
  <h2 class="text-primary fw-bold">Registrar Préstamos</h2>

  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">Nuevo Préstamo</div>
    <div class="card-body">

      <form id="formPrestamo">
        <div class="mb-3">
          <label class="form-label">ID del Instrumento</label>
          <input type="number" class="form-control" id="instrumento_id" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Correo del Usuario</label>
          <input type="email" class="form-control" id="usuario_correo" required>
        </div>

        <button type="submit" class="btn btn-primary w-100">Registrar Préstamo</button>
      </form>

    </div>
  </div>

  <h3 class="mt-4 text-primary">Lista de Préstamos</h3>

  <table class="table table-striped table-bordered" id="tablaPrestamos">
    <thead class="table-primary">
      <tr>
        <th>ID</th>
        <th>Instrumento</th>
        <th>Usuario</th>
        <th>Salida</th>
        <th>Regreso</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<script>
// Navbar
fetch('navbar.html')
  .then(r => r.text())
  .then(html => document.getElementById('navbar').innerHTML = html);

const rol = localStorage.getItem("rol");

// Cargar préstamos
function cargarPrestamos() {
  fetch('/api/prestamos', { headers: { 'x-rol': rol } })
    .then(r => r.json())
    .then(data => {
      const tbody = document.querySelector("#tablaPrestamos tbody");
      tbody.innerHTML = "";
      data.forEach(p => {
        tbody.innerHTML += `
          <tr>
            <td>${p.id}</td>
            <td>${p.instrumento}</td>
            <td>${p.usuario_correo}</td>
            <td>${p.fecha_salida}</td>
            <td>${p.fecha_regreso || "-"}</td>
            <td>
              ${p.fecha_regreso ? "✔️ Devuelto" : `
                <button class="btn btn-success btn-sm" onclick="devolver(${p.id})">Devolver</button>
              `}
            </td>
          </tr>
        `;
      });
    });
}

// Registrar un préstamo
document.getElementById("formPrestamo").addEventListener("submit", e => {
  e.preventDefault();
  const datos = {
    instrumento_id: instrumento_id.value,
    usuario_correo: usuario_correo.value
  };

  fetch('/api/prestamos', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-rol': rol },
    body: JSON.stringify(datos)
  })
    .then(r => r.json())
    .then(d => {
      alert(d.mensaje);
      cargarPrestamos();
    });
});

// Devolver préstamo
function devolver(id) {
  fetch(`/api/prestamos/${id}/devolver`, {
    method: 'PUT',
    headers: { 'x-rol': rol }
  })
    .then(r => r.json())
    .then(d => {
      alert(d.mensaje);
      cargarPrestamos();
    });
}

cargarPrestamos();
</script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
